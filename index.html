<!DOCTYPE html>
<html lang="en" class=""> <!-- 'dark' class will be added here for dark mode -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Central Hub Directory</title>
    <link rel="icon" type="image/png" href="https://i.imgur.com/U4WPjmA.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <!-- Modern Icons Library -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --background: #f1f5f9; /* slate-100 */
            --foreground: #0f172a; /* slate-900 */
            --sidebar-bg: #ffffff;
            --card-bg: rgba(255, 255, 255, 0.6);
            --card-border: rgba(0, 0, 0, 0.05);
            --card-foreground: #0f172a;
            --primary-start: #3b82f6; /* blue-500 */
            --primary-end: #2563eb; /* blue-600 */
            --primary-foreground: #f8fafc;
            --secondary-bg: rgba(241, 245, 249, 0.7); /* slate-100 */
            --secondary-foreground: #0f172a;
            --muted-foreground: #64748b; /* slate-500 */
            --destructive: #ef4444; /* red-500 */
            --destructive-foreground: #f8fafc;
            --ring: #2563eb;
            --mouse-x: 50%;
            --mouse-y: 50%;
        }

        .dark {
            --background: #020817; /* slate-950 */
            --foreground: #f8fafc;
            --sidebar-bg: #0f172a; /* slate-900 */
            --card-bg: rgba(22, 34, 57, 0.5); /* adjusted slate-900 */
            --card-border: rgba(255, 255, 255, 0.1);
            --card-foreground: #f8fafc;
            --primary-start: #60a5fa; /* blue-400 */
            --primary-end: #3b82f6; /* blue-500 */
            --primary-foreground: #f8fafc;
            --secondary-bg: rgba(30, 41, 59, 0.5); /* slate-800 */
            --secondary-foreground: #f8fafc;
            --muted-foreground: #94a3b8; /* slate-400 */
            --destructive: #dc2626; /* red-600 */
            --destructive-foreground: #f8fafc;
            --ring: #3b82f6;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--foreground);
            transition: background-color 0.3s, color 0.3s;
            overflow: hidden; /* Prevent scrollbars on body */
        }

        h2, h3 {
            font-family: 'Poppins', sans-serif;
        }

        #bg-wrap {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden;
        }
        #bg-wrap::before {
             content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
             background: radial-gradient(circle at var(--mouse-x) var(--mouse-y), rgba(60, 130, 246, 0.15), transparent 40%);
             opacity: 0; transition: opacity 0.5s;
        }
        body:not(:has(#auth-container:not([style*="display: none"]))) #bg-wrap::before {
             opacity: 1;
        }

        .color-blob {
            position: absolute; border-radius: 50%; opacity: 0.3; filter: blur(100px); animation: move 25s infinite alternate;
        }
        .blob-1 { background-color: #3b82f6; width: 400px; height: 400px; top: 10%; left: 10%; }
        .blob-2 { background-color: #ec4899; width: 300px; height: 300px; top: 60%; left: 80%; animation-delay: 5s; }
        .blob-3 { background-color: #14b8a6; width: 350px; height: 350px; top: 70%; left: 20%; animation-delay: 10s;}
        
        @keyframes move {
            from { transform: translate(-100px, -50px) rotate(-90deg) scale(0.8); }
            to { transform: translate(100px, 100px) rotate(90deg) scale(1.2); }
        }
        
        /* Glassmorphism Styles */
        .glass-panel {
            background-color: var(--card-bg); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border: 1px solid var(--card-border); color: var(--card-foreground);
        }

        .input-base {
            background-color: var(--secondary-bg); border: 1px solid var(--card-border); color: var(--foreground);
        }
        .input-base:focus {
            --tw-ring-color: var(--ring); border-color: var(--ring);
        }
        .btn-primary { 
            background-image: linear-gradient(to right, var(--primary-start), var(--primary-end));
            color: var(--primary-foreground);
            background-size: 200% auto;
            transition: background-position 0.3s ease-in-out;
        }
        .btn-primary:hover {
            background-position: right center;
        }
        .btn-secondary {
            background-color: var(--secondary-bg); color: var(--secondary-foreground); border: 1px solid var(--card-border);
        }
        .btn-destructive { background-color: var(--destructive); color: var(--destructive-foreground); }

        /* Card Parallax Hover Effect */
        .project-card {
            transform-style: preserve-3d; transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        .project-card .card-content, .project-card .card-actions, .project-card .card-tags {
            transform: translateZ(20px); /* Bring content forward */
        }
        .project-card .card-icon-wrapper {
            transform: translateZ(50px); /* Bring icon even more forward */
        }
        
        .favorite-btn.favorited svg { fill: #facc15; stroke: #facc15; }
        .notification-dot { position: absolute; top: -2px; right: -2px; width: 10px; height: 10px; border-radius: 50%; background-color: var(--destructive); border: 2px solid var(--card-bg); }
        .tab-btn.active { border-color: var(--primary-end); color: var(--primary-start); }
        .sidebar-filter-link.active { 
            background-image: linear-gradient(to right, var(--primary-start), var(--primary-end));
            color: var(--primary-foreground);
            box-shadow: 0 4px 15px -5px var(--primary-start);
        }
        .sidebar-filter-link:hover:not(.active) {
            transform: translateX(4px);
        }

        /* Modal Transitions */
        .modal {
            transition: opacity 0.3s ease-in-out;
        }
        .modal .modal-content {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            transform: scale(0.95);
            opacity: 0;
        }
        .modal:not(.opacity-0) .modal-content {
            transform: scale(1);
            opacity: 1;
        }

        /* Tagging System */
        .tag-badge {
            background-color: var(--secondary-bg);
            color: var(--muted-foreground);
            border: 1px solid var(--card-border);
            cursor: pointer;
            transition: all 0.2s;
        }
        .tag-badge:hover {
            background-color: var(--primary-start);
            color: var(--primary-foreground);
            border-color: transparent;
        }
        .tag-input-badge {
            display: inline-flex; align-items: center; background-color: var(--primary-start); color: var(--primary-foreground); padding: 2px 8px; border-radius: 9999px; font-size: 0.875rem; margin: 2px;
        }
        .tag-input-badge button { margin-left: 6px; font-weight: bold; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: rgba(128, 128, 128, 0.3); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background-color: rgba(128, 128, 128, 0.5); }
    </style>
</head>
<body class="min-h-screen">
    <div id="bg-wrap">
        <div class="color-blob blob-1"></div>
        <div class="color-blob blob-2"></div>
        <div class="color-blob blob-3"></div>
    </div>

    <!-- Auth Container -->
    <div id="auth-container" class="w-full min-h-screen flex items-center justify-center p-4">
        <!-- Auth content remains the same -->
        <div class="glass-panel w-full max-w-md mx-auto rounded-2xl shadow-2xl p-8">
            <div class="flex justify-center items-center mb-6">
                <img src="https://i.imgur.com/GQya5pg.png" alt="Brand Logo" class="h-20" onerror="this.style.display='none'">
            </div>
            
            <form id="login-form">
                <h2 class="text-2xl font-bold text-center mb-2">Central Hub Login</h2>
                <p class="text-center text-[var(--muted-foreground)] mb-6">Please sign in to continue.</p>
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium mb-2">Email</label>
                    <input type="email" id="email" name="email" required class="input-base w-full rounded-lg px-3 py-2 focus:outline-none focus:ring-2 transition-all">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium mb-2">Password</label>
                    <input type="password" id="password" name="password" required class="input-base w-full rounded-lg px-3 py-2 focus:outline-none focus:ring-2 transition-all">
                </div>
                <button type="submit" class="btn-primary w-full font-semibold py-2.5 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--ring)] transition-colors">Sign In</button>
                <p id="auth-error" class="text-[var(--destructive)] text-center text-sm mt-4 h-4"></p>
            </form>

            <form id="signup-form" class="hidden">
                 <h2 class="text-2xl font-bold text-center mb-2">Create Your Account</h2>
                <p class="text-center text-[var(--muted-foreground)] mb-6">Complete your registration.</p>
                <div class="mb-4">
                    <label for="signup-email" class="block text-sm font-medium mb-2">Email</label>
                    <input type="email" id="signup-email" name="email" required class="input-base w-full rounded-lg px-3 py-2 focus:outline-none focus:ring-2 transition-all">
                </div>
                <div class="mb-4">
                    <label for="signup-password" class="block text-sm font-medium mb-2">Password</label>
                    <input type="password" id="signup-password" name="password" required class="input-base w-full rounded-lg px-3 py-2 focus:outline-none focus:ring-2 transition-all">
                </div>
                <button type="submit" class="btn-primary w-full font-semibold py-2.5 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--ring)] transition-colors">Sign Up</button>
                <p id="signup-error" class="text-[var(--destructive)] text-center text-sm mt-4 h-4"></p>
            </form>

            <div class="text-center mt-6">
                <a href="#" id="auth-toggle-link" class="text-sm text-[var(--primary-start)] hover:underline">Don't have an account? Sign Up</a>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden h-screen w-full flex">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-[var(--sidebar-bg)] border-r border-[var(--card-border)] flex flex-col p-4">
            <div class="flex flex-col items-center space-y-2 mb-8">
                <img src="https://i.imgur.com/GQya5pg.png" alt="Brand Logo" class="h-12" onerror="this.style.display='none'">
                <h1 class="text-xl font-bold">Central Hub</h1>
            </div>
            
            <nav id="filter-navigation" class="flex-grow space-y-2">
                <!-- Filter links will be dynamically inserted here -->
            </nav>

            <div class="mt-auto pt-4 border-t border-[var(--card-border)] space-y-2">
                <div id="user-profile-container" class="mb-2"></div>
                <button id="theme-switcher" class="w-full flex items-center space-x-3 px-3 py-2 rounded-lg text-sm font-medium text-[var(--muted-foreground)] hover:bg-[var(--secondary-bg)] transition-colors">
                    <i data-lucide="sun" class="block dark:hidden"></i>
                    <i data-lucide="moon" class="hidden dark:block"></i>
                    <span>Toggle Theme</span>
                </button>
                 <button id="sign-out-btn" class="w-full flex items-center space-x-3 px-3 py-2 rounded-lg text-sm font-medium text-[var(--muted-foreground)] hover:bg-[var(--secondary-bg)] transition-colors">
                    <i data-lucide="log-out"></i>
                    <span>Sign Out</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <div id="main-content-wrapper" class="flex-1 flex flex-col h-screen">
            <header class="flex-shrink-0 bg-[var(--background)]/80 backdrop-blur-sm border-b border-[var(--card-border)] p-4 flex items-center justify-between">
                <div class="relative w-full max-w-md">
                   <input type="text" id="search-input" placeholder="Search by name, description, or tag..." class="input-base w-full pl-10 pr-4 py-2 rounded-full text-sm focus:outline-none focus:ring-2 transition-all">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i data-lucide="search" class="h-5 w-5 text-[var(--muted-foreground)]"></i>
                    </div>
                </div>

                <div class="flex items-center space-x-2">
                    <div id="admin-controls" class="hidden flex items-center space-x-2">
                        <button id="add-project-btn" class="btn-primary p-2.5 rounded-full shadow-lg transition-transform transform hover:scale-105" title="Add Project">
                            <i data-lucide="plus"></i>
                        </button>
                        <button id="manage-users-btn" class="btn-secondary p-2.5 rounded-full shadow-lg transition-transform transform hover:scale-105" title="Manage Users">
                            <i data-lucide="users"></i>
                        </button>
                    </div>
                     <div class="relative">
                        <button id="notification-btn" class="btn-secondary p-2.5 rounded-full shadow-lg transition-transform transform hover:scale-105" title="Notifications">
                            <i data-lucide="bell"></i>
                            <div id="notification-dot" class="hidden notification-dot"></div>
                        </button>
                        <div id="notification-panel" class="hidden absolute right-0 mt-2 w-80 sm:w-96 glass-panel rounded-lg shadow-xl z-20">
                            <div class="p-3 border-b border-[var(--card-border)] flex justify-between items-center">
                                <h3 class="font-semibold">Notifications</h3>
                                <button id="clear-notifications-btn" class="text-sm text-[var(--primary-start)] hover:underline">Mark all as read</button>
                            </div>
                            <ul id="notification-list" class="max-h-96 overflow-y-auto p-2"></ul>
                        </div>
                    </div>
                </div>
            </header>
            <main id="main-content" class="flex-1 overflow-y-auto p-6 md:p-8">
                <div id="loading-indicator" class="text-center py-16">
                     <div role="status" class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-[var(--primary-start)] border-r-transparent align-[-0.125em] motion-reduce:animate-[spin_1.5s_linear_infinite]"></div>
                    <p class="mt-4 text-lg text-[var(--muted-foreground)]">Loading projects...</p>
                </div>
                 <div id="empty-state-message" class="hidden text-center py-16"></div>
                 <footer class="text-center mt-16 text-[var(--muted-foreground)]/80 pb-8">
                    <p>Created by Dom. All data is live.</p>
                </footer>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="file-list-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4 opacity-0 pointer-events-none"></div>
    <div id="project-form-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4 opacity-0 pointer-events-none"></div>
    <div id="user-management-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4 opacity-0 pointer-events-none"></div>
    <div id="confirm-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4 opacity-0 pointer-events-none"></div>
    <div id="project-details-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4 opacity-0 pointer-events-none"></div>
    <div id="user-profile-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4 opacity-0 pointer-events-none"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, getDoc, setDoc, getDocs, writeBatch, serverTimestamp, query, orderBy, limit, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBpU5pgitYuVLh1mAYHdLqt_CPkyyqVXms",
            authDomain: "central-hub-a3d68.firebaseapp.com",
            projectId: "central-hub-a3d68",
            storageBucket: "central-hub-a3d68.firebasestorage.app",
            messagingSenderId: "4439926098",
            appId: "1:4439926098:web:3430ec708c3726f67d068b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const projectsCollection = collection(db, "projects");
        const usersCollection = collection(db, "users");
        const invitesCollection = collection(db, "invites");
        const notificationsCollection = collection(db, "notifications");

        // --- DOM Elements ---
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const mainContent = document.getElementById('main-content');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const authToggleLink = document.getElementById('auth-toggle-link');
        const authError = document.getElementById('auth-error');
        const signupError = document.getElementById('signup-error');
        const signOutBtn = document.getElementById('sign-out-btn');
        const adminControls = document.getElementById('admin-controls');
        const manageUsersBtn = document.getElementById('manage-users-btn');
        const searchInput = document.getElementById('search-input');
        const filterNavigation = document.getElementById('filter-navigation');
        const fileListModalEl = document.getElementById('file-list-modal');
        const projectFormModalEl = document.getElementById('project-form-modal');
        const userManagementModalEl = document.getElementById('user-management-modal');
        const confirmModalEl = document.getElementById('confirm-modal');
        const projectDetailsModalEl = document.getElementById('project-details-modal');
        const userProfileModalEl = document.getElementById('user-profile-modal');
        const addProjectBtn = document.getElementById('add-project-btn');
        const loadingIndicator = document.getElementById('loading-indicator');
        const emptyStateMessage = document.getElementById('empty-state-message');
        const themeSwitcher = document.getElementById('theme-switcher');
        const notificationBtn = document.getElementById('notification-btn');
        const notificationPanel = document.getElementById('notification-panel');
        const notificationList = document.getElementById('notification-list');
        const notificationDot = document.getElementById('notification-dot');
        const clearNotificationsBtn = document.getElementById('clear-notifications-btn');
        
        // --- App State ---
        let allProjects = []; let activeFilter = 'All'; let currentUser = null;
        let userRole = null; let unsubscribeProjects = null; let unsubscribeNotifications = null;
        let favorites = []; let notifications = [];
        
        // --- Local Storage Helpers ---
        const getLocalStorageKey = (key) => currentUser ? `${key}_${currentUser.uid}` : null;
        const saveToLocalStorage = (key, data) => { const userKey = getLocalStorageKey(key); if(userKey) localStorage.setItem(userKey, JSON.stringify(data)); };
        const loadFromLocalStorage = (key, defaultValue = '[]') => {
            const userKey = getLocalStorageKey(key);
            if (!userKey) return JSON.parse(defaultValue);
            try {
                const item = localStorage.getItem(userKey);
                return item ? JSON.parse(item) : JSON.parse(defaultValue);
            } catch (e) {
                console.warn(`Could not parse local storage item ${userKey}:`, e);
                return JSON.parse(defaultValue);
            }
        };
        
        // --- Authentication ---
        onAuthStateChanged(auth, async (user) => {
            try {
                const userProfileContainer = document.getElementById('user-profile-container');
                if (user) {
                    currentUser = user;
                    await fetchUserRole(user.uid);
                    favorites = loadFromLocalStorage('favoriteProjects');
                    authContainer.style.display = 'none'; appContainer.classList.remove('hidden');
                    if (userRole === 'admin') adminControls.classList.remove('hidden');

                    userProfileContainer.innerHTML = `
                        <button id="user-profile-btn" class="w-full flex items-center space-x-3 px-3 py-2 rounded-lg text-sm font-medium text-left bg-[var(--secondary-bg)] hover:bg-[var(--card-border)] transition-colors">
                            <i data-lucide="user-circle-2"></i>
                            <span class="truncate flex-1">${currentUser.email}</span>
                        </button>
                    `;
                    lucide.createIcons();
                    
                    if (unsubscribeProjects) unsubscribeProjects();
                    const projectsQuery = query(projectsCollection, orderBy("title"));
                    unsubscribeProjects = onSnapshot(projectsQuery, (snapshot) => {
                        allProjects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        loadingIndicator.style.display = 'none';
                        renderAll();
                    }, (error) => {
                        console.error("Error with projects listener:", error);
                        loadingIndicator.style.display = 'none';
                        mainContent.innerHTML = `<p class="text-[var(--destructive)] text-center">Failed to load projects.</p>`;
                    });

                    if (unsubscribeNotifications) unsubscribeNotifications();
                    const notificationsQuery = query(notificationsCollection, orderBy("timestamp", "desc"), limit(20));
                    unsubscribeNotifications = onSnapshot(notificationsQuery, (snapshot) => {
                        notifications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderNotifications();
                    });

                } else {
                    currentUser = null; userRole = null;
                    if (unsubscribeProjects) { unsubscribeProjects(); unsubscribeProjects = null; }
                    if (unsubscribeNotifications) { unsubscribeNotifications(); unsubscribeNotifications = null; }
                    allProjects = []; mainContent.innerHTML = '';
                    userProfileContainer.innerHTML = '';
                    authContainer.style.display = 'flex'; appContainer.classList.add('hidden');
                    adminControls.classList.add('hidden');
                }
            } catch (error) {
                console.error("Critical error during auth state change:", error);
                signOut(auth);
            }
        });

        async function fetchUserRole(uid) {
            const userDoc = await getDoc(doc(db, "users", uid));
            userRole = userDoc.exists() ? userDoc.data().role : 'viewer';
        }
        
        // --- Rendering ---
        function renderAll() {
            mainContent.querySelectorAll('.project-section').forEach(el => el.remove());
            emptyStateMessage.classList.add('hidden');

            const staticCategories = [...new Set(allProjects.map(p => p.category))];
            staticCategories.sort((a, b) => { if (a === 'Web Apps') return -1; if (b === 'Web Apps') return 1; return a.localeCompare(b); });
            const allCategories = ['Favorites', ...staticCategories];

            allCategories.forEach(createSection);
            
            const projectMap = new Map(allProjects.map(p => [p.id, p]));
            const favoriteProjects = favorites.map(id => projectMap.get(id)).filter(Boolean);
            populateGrid('Favorites', favoriteProjects);
            
            staticCategories.forEach(category => {
                const categoryProjects = allProjects.filter(p => p.category === category);
                populateGrid(category, categoryProjects);
            });
            
            renderFilterNavigation();
            filterAndSearch();
            lucide.createIcons();
            addParallaxEventListeners();
        }

        function createSection(category) {
            const sectionId = `section-${category.replace(/\s+/g, '-')}`;
            if(document.getElementById(sectionId)) return;
            const section = document.createElement('div');
            section.id = sectionId;
            section.className = 'mb-12 project-section';
            section.innerHTML = `<h2 class="text-2xl font-bold mb-6">${category}</h2><div class="project-grid grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" data-category="${category}"></div>`;
            mainContent.insertBefore(section, mainContent.querySelector('footer'));
        }

        function populateGrid(category, items) {
            const section = document.getElementById(`section-${category.replace(/\s+/g, '-')}`);
            if (!section) return;
            const grid = section.querySelector('.project-grid');
            grid.innerHTML = '';
            if (items.length === 0) {
                if (category === 'Favorites') {
                    grid.innerHTML = `<p class="text-[var(--muted-foreground)] italic col-span-full">No items have been favorited yet.</p>`;
                    section.classList.remove('section-hidden');
                } else {
                    section.classList.add('section-hidden');
                }
                return;
            }
            section.classList.remove('section-hidden');
            items.forEach((item, index) => {
                const card = createCard(item);
                card.style.transitionDelay = `${index * 30}ms`;
                grid.appendChild(card);
                setTimeout(() => card.classList.remove('opacity-0', 'translate-y-5'), 50);
            });
        }

        function createCard(project) {
            const card = document.createElement('div');
            card.className = `project-card glass-panel opacity-0 translate-y-5 block p-5 rounded-2xl shadow-lg transition-all duration-300 ease-in-out hover:shadow-xl hover:border-[var(--primary-start)] cursor-pointer`;
            card.dataset.id = project.id; 
            card.dataset.title = project.title.toLowerCase(); 
            card.dataset.description = project.description ? project.description.toLowerCase() : '';
            card.dataset.category = project.category;
            card.dataset.tags = project.tags ? project.tags.join(',') : '';

            const isFavorited = favorites.includes(project.id);
            const adminButtonsHTML = userRole === 'admin' ? `<button class="edit-btn p-2 rounded-full bg-[var(--secondary-bg)] hover:bg-[var(--card-border)] transition-colors" title="Edit"><i data-lucide="pencil" class="h-4 w-4"></i></button><button class="delete-btn p-2 rounded-full bg-[var(--secondary-bg)] hover:bg-[var(--destructive)] hover:text-white transition-colors" title="Delete"><i data-lucide="trash-2" class="h-4 w-4"></i></button>` : '';
            const tagsHTML = project.tags && project.tags.length > 0 
                ? `<div class="card-tags mt-4 flex flex-wrap gap-2">${project.tags.map(tag => `<span class="tag-badge text-xs font-medium px-2.5 py-1 rounded-full">${tag}</span>`).join('')}</div>`
                : '';
            
            card.innerHTML = `
            <div class="relative h-full flex flex-col pointer-events-none">
                <div class="card-content flex-grow flex items-start space-x-4">
                    <div class="card-icon-wrapper flex-shrink-0 w-16 h-16 ${project.bgColor || 'bg-gray-500'} rounded-lg flex items-center justify-center shadow-inner-lg text-slate-800">${project.icon || ''}</div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold">${project.title}</h3>
                        <p class="mt-1 text-sm text-[var(--muted-foreground)]">${project.description || ''}</p>
                    </div>
                </div>
                ${tagsHTML}
                <div class="card-actions absolute top-[-15px] right-[-15px] flex space-x-1 pointer-events-auto">
                    <button class="favorite-btn p-2 rounded-full bg-[var(--secondary-bg)] hover:bg-[var(--card-border)] transition-colors ${isFavorited ? 'favorited' : ''}" title="Favorite"><svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg></button>
                    ${adminButtonsHTML}
                </div>
            </div>`;
            return card;
        }

        // --- Notifications ---
        function renderNotifications() {
            const lastSeenTimestamp = loadFromLocalStorage('lastSeenNotification', '0');
            let hasUnread = false;
            if (notifications.length === 0) {
                notificationList.innerHTML = `<li class="p-4 text-center text-sm text-[var(--muted-foreground)]">No new notifications.</li>`;
            } else {
                notificationList.innerHTML = notifications.map(notif => {
                    const isUnread = notif.timestamp && notif.timestamp.toMillis() > lastSeenTimestamp;
                    if(isUnread) hasUnread = true;
                    return `<li class="border-b border-[var(--card-border)] last:border-b-0"><div class="p-3 hover:bg-[var(--card-border)] rounded-md transition-colors"><p class="font-medium">${notif.message}</p><p class="text-xs text-[var(--muted-foreground)] mt-1">${timeAgo(notif.timestamp)} by ${notif.userEmail}</p></div></li>`;
                }).join('');
            }
            notificationDot.classList.toggle('hidden', !hasUnread);
        }
        function timeAgo(timestamp) {
            if (!timestamp) return 'Just now';
            const now = Date.now();
            const seconds = Math.floor((now - timestamp.toMillis()) / 1000);
            let interval = seconds / 31536000; if (interval > 1) return Math.floor(interval) + " years ago";
            interval = seconds / 2592000; if (interval > 1) return Math.floor(interval) + " months ago";
            interval = seconds / 86400; if (interval > 1) return Math.floor(interval) + " days ago";
            interval = seconds / 3600; if (interval > 1) return Math.floor(interval) + " hours ago";
            interval = seconds / 60; if (interval > 1) return Math.floor(interval) + " minutes ago";
            return "Just now";
        }
        async function createNotification(action, title) {
            const message = `${action}: "${title}"`;
            try { await addDoc(notificationsCollection, { message, userEmail: currentUser.email, timestamp: serverTimestamp(), }); } 
            catch (error) { console.error("Error creating notification: ", error); }
        }
        clearNotificationsBtn.addEventListener('click', () => { saveToLocalStorage('lastSeenNotification', Date.now().toString()); renderNotifications(); });
        
        // --- Filtering and Empty States ---
        function renderFilterNavigation() {
            const categories = ['All', 'Favorites', ...new Set(allProjects.map(p => p.category))];
            const categoryIcons = { 'All': 'layout-grid', 'Favorites': 'star', 'Web Apps': 'app-window', 'Tools': 'wrench', 'System Files': 'folder-cog' };
            filterNavigation.innerHTML = categories.map(cat => `
                <a href="#" data-category="${cat}" class="sidebar-filter-link flex items-center space-x-3 px-3 py-2 rounded-lg text-sm font-medium text-[var(--muted-foreground)] hover:bg-[var(--secondary-bg)] transition-all duration-200 ${cat === activeFilter ? 'active' : ''}">
                    <i data-lucide="${categoryIcons[cat] || 'folder'}"></i><span class="whitespace-nowrap">${cat}</span>
                </a>
            `).join('');
            lucide.createIcons();
        }
        
        function filterAndSearch() {
            let searchTerm = searchInput.value.toLowerCase();
            const isTagSearch = searchTerm.startsWith('tag:');
            if (isTagSearch) {
                searchTerm = searchTerm.substring(4).trim();
            }
            
            let totalVisibleCards = 0;
            
            document.querySelectorAll('.project-card').forEach(card => {
                const titleMatch = card.dataset.title.includes(searchTerm);
                const descMatch = card.dataset.description.includes(searchTerm);
                const tagMatch = isTagSearch ? card.dataset.tags.includes(searchTerm) : card.dataset.tags.includes(searchTerm);
                
                const searchMatch = isTagSearch ? tagMatch : (titleMatch || descMatch || tagMatch);

                let categoryMatch = false;
                if (activeFilter === 'All') {
                    categoryMatch = true;
                } else if (activeFilter === 'Favorites') {
                    categoryMatch = favorites.includes(card.dataset.id);
                } else {
                    categoryMatch = card.dataset.category === activeFilter;
                }
                
                const isVisible = searchMatch && categoryMatch;
                card.classList.toggle('hidden', !isVisible);
                if (isVisible) totalVisibleCards++;
            });

            updateSectionVisibility();

            if (totalVisibleCards === 0 && allProjects.length > 0) {
                mainContent.querySelectorAll('.project-section').forEach(s => s.classList.add('section-hidden'));
                emptyStateMessage.innerHTML = `<i data-lucide="search-x" class="h-16 w-16 mx-auto text-[var(--muted-foreground)]"></i><h3 class="mt-4 text-xl font-semibold">No Results Found</h3><p class="mt-2 text-[var(--muted-foreground)]">No projects matched your search for "${searchInput.value}".</p>`;
                emptyStateMessage.classList.remove('hidden');
            } else if (allProjects.length === 0) {
                 emptyStateMessage.innerHTML = `<i data-lucide="inbox" class="h-16 w-16 mx-auto text-[var(--muted-foreground)]"></i><h3 class="mt-4 text-xl font-semibold">No Projects Yet</h3><p class="mt-2 text-[var(--muted-foreground)]">Admins can add the first project to get started.</p>`;
                emptyStateMessage.classList.remove('hidden');
            } else {
                emptyStateMessage.classList.add('hidden');
            }
            lucide.createIcons();
        }

        function updateSectionVisibility() {
            document.querySelectorAll('.project-section').forEach(section => {
                const hasVisibleCards = section.querySelectorAll('.project-card:not(.hidden)').length > 0;
                section.classList.toggle('section-hidden', !hasVisibleCards);
            });
        }
        
        // --- Modals & Forms ---
        function showFileList(project) {
            const filesHTML = project.files && project.files.length > 0 ? project.files.map(file => `<li><a href="${file.url}" target="_blank" rel="noopener noreferrer" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-[var(--secondary-bg)] transition-colors duration-200"><i data-lucide="file-text" class="h-5 w-5 text-[var(--muted-foreground)]"></i><span>${file.title}</span></a></li>`).join('') : `<li class="p-3 text-[var(--muted-foreground)]">No files listed.</li>`;
            fileListModalEl.innerHTML = `<div class="modal-content glass-panel w-full max-w-md rounded-2xl shadow-2xl p-6"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">${project.title}</h2><button class="close-modal-btn text-[var(--muted-foreground)] hover:text-[var(--foreground)] transition-colors"><i data-lucide="x"></i></button></div><ul class="space-y-1 max-h-80 overflow-y-auto">${filesHTML}</ul></div>`;
            fileListModalEl.classList.remove('opacity-0', 'pointer-events-none');
            lucide.createIcons();
        }
        function showProjectForm(project = {}) {
            const isEditing = !!project.id;
            const files = project.files || [];
            let currentTags = project.tags || [];

            const colorPalette = ['bg-slate-200', 'bg-red-200', 'bg-orange-200', 'bg-amber-200', 'bg-yellow-200', 'bg-lime-200', 'bg-green-200', 'bg-emerald-200', 'bg-teal-200', 'bg-cyan-200', 'bg-sky-200', 'bg-blue-200', 'bg-indigo-200', 'bg-violet-200', 'bg-purple-200', 'bg-fuchsia-200', 'bg-pink-200', 'bg-rose-200'];
            const iconList = ['database', 'layout-dashboard', 'bar-chart-3', 'box', 'folder', 'file-text', 'dollar-sign', 'file-check', 'clipboard-list', 'archive', 'settings', 'globe', 'server', 'pen-tool', 'shopping-cart', 'trending-up' ];
            let colorPickerHTML = colorPalette.map(c => `<button type="button" data-color="${c}" class="w-8 h-8 rounded-full ${c} ring-2 ring-transparent ring-offset-2 ring-offset-[var(--card-bg)] focus:ring-[var(--primary-start)] transition ${project.bgColor === c ? 'ring-[var(--primary-start)]' : ''}"></button>`).join('');
            let iconPickerHTML = iconList.map(i => `<button type="button" data-icon="${i}" class="p-2 rounded-md hover:bg-[var(--secondary-bg)] transition ${project.iconName === i ? 'bg-[var(--secondary-bg)] text-[var(--primary-start)]' : 'text-[var(--muted-foreground)]'}"><i data-lucide="${i}"></i></button>`).join('');
            const filesHTML = files.map((file, index) => `<div class="flex items-center space-x-2" data-file-index="${index}"><input type="text" placeholder="File Name" value="${file.title || ''}" class="input-base file-title-input w-1/2 rounded-md px-3 py-2"><input type="url" placeholder="File URL" value="${file.url || ''}" class="input-base file-url-input w-1/2 rounded-md px-3 py-2"><button type="button" class="remove-file-btn text-[var(--destructive)] hover:opacity-80 p-2">&times;</button></div>`).join('');
            
            projectFormModalEl.innerHTML = `
                <div class="modal-content glass-panel w-full max-w-lg rounded-2xl shadow-2xl p-6 max-h-[90vh] overflow-y-auto">
                    <form id="project-form">
                        <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">${isEditing ? 'Edit Project' : 'Add New Project'}</h2><button type="button" class="close-modal-btn text-[var(--muted-foreground)] hover:text-[var(--foreground)] transition-colors"><i data-lucide="x"></i></button></div>
                        <div class="space-y-4">
                            <input type="hidden" name="id" value="${project.id || ''}"><input type="hidden" name="bgColor" value="${project.bgColor || 'bg-slate-200'}"><input type="hidden" name="iconName" value="${project.iconName || 'box'}">
                            <div><label class="text-sm font-medium mb-2 block">Title</label><input type="text" name="title" placeholder="Project Title" value="${project.title || ''}" required class="input-base w-full rounded-md px-3 py-2"></div>
                            <div><label class="text-sm font-medium mb-2 block">Description</label><textarea name="description" placeholder="Description" class="input-base w-full rounded-md px-3 py-2 min-h-[80px]">${project.description || ''}</textarea></div>
                            <div><label class="text-sm font-medium mb-2 block">Category</label><input type="text" name="category" list="category-suggestions" placeholder="e.g., Web Apps" value="${project.category || ''}" required class="input-base w-full rounded-md px-3 py-2"></div>
                            <datalist id="category-suggestions">${[...new Set(allProjects.map(p=>p.category))].map(c=>`<option value="${c}">`).join('')}</datalist>
                            <div>
                                <label class="text-sm font-medium mb-2 block">Tags</label>
                                <div id="tag-input-container" class="input-base w-full rounded-md px-3 py-2 flex flex-wrap items-center gap-1">
                                    <input type="text" id="tag-input" placeholder="Add tags..." class="bg-transparent flex-grow focus:outline-none">
                                </div>
                            </div>
                            <div><label class="text-sm font-medium mb-2 block">Type</label><select name="type" class="input-base w-full rounded-md px-3 py-2"><option value="webapp" ${project.type === 'webapp' ? 'selected' : ''}>Web App</option><option value="folder" ${project.type === 'folder' ? 'selected' : ''}>System Files Folder</option></select></div>
                            <div class="url-container ${project.type === 'folder' ? 'hidden' : ''}"><label class="text-sm font-medium mb-2 block">URL (for Web Apps)</label><input type="url" name="url" placeholder="https://..." value="${project.url || ''}" class="input-base w-full rounded-md px-3 py-2"></div>
                            <div><label class="text-sm font-medium mb-2 block">Color</label><div id="color-picker" class="flex flex-wrap gap-2">${colorPickerHTML}</div></div>
                            <div><label class="text-sm font-medium mb-2 block">Icon</label><div id="icon-picker" class="grid grid-cols-8 gap-1 p-2 border border-[var(--card-border)] rounded-lg">${iconPickerHTML}</div></div>
                            <div id="files-container" class="${project.type === 'folder' ? '' : 'hidden'}"><h4 class="text-lg font-semibold mt-4">Files</h4><div id="files-list" class="space-y-2 mt-2">${filesHTML}</div><button type="button" id="add-file-btn" class="mt-2 text-sm text-[var(--primary-start)] hover:opacity-80 font-semibold">+ Add File</button></div>
                        </div>
                        <p id="form-error" class="text-[var(--destructive)] text-center text-sm mt-4 h-4"></p>
                        <div class="flex justify-end space-x-4 mt-6"><button type="button" class="close-modal-btn btn-secondary px-4 py-2 rounded-md font-semibold hover:opacity-90">Cancel</button><button type="submit" class="btn-primary px-4 py-2 rounded-md font-semibold hover:opacity-90">Save Project</button></div>
                    </form>
                </div>`;
            
            projectFormModalEl.classList.remove('opacity-0', 'pointer-events-none');
            
            const tagInput = projectFormModalEl.querySelector('#tag-input');
            const tagContainer = projectFormModalEl.querySelector('#tag-input-container');

            const renderTags = () => {
                tagContainer.querySelectorAll('.tag-input-badge').forEach(el => el.remove());
                currentTags.forEach(tag => {
                    const badge = document.createElement('span');
                    badge.className = 'tag-input-badge';
                    badge.innerHTML = `${tag} <button type="button" data-tag="${tag}">&times;</button>`;
                    tagContainer.insertBefore(badge, tagInput);
                });
            };
            
            tagContainer.addEventListener('click', e => {
                if (e.target.tagName === 'BUTTON' && e.target.dataset.tag) {
                    currentTags = currentTags.filter(t => t !== e.target.dataset.tag);
                    renderTags();
                }
            });

            tagInput.addEventListener('keydown', e => {
                if (e.key === 'Enter' || e.key === ',') {
                    e.preventDefault();
                    const newTag = tagInput.value.trim().toLowerCase();
                    if (newTag && !currentTags.includes(newTag)) {
                        currentTags.push(newTag);
                        renderTags();
                    }
                    tagInput.value = '';
                }
            });

            renderTags(); // Initial render for editing

            projectFormModalEl.querySelector('#project-form').addEventListener('submit', e => handleFormSubmit(e, currentTags));
            const typeSelect = projectFormModalEl.querySelector('select[name="type"]'); if (typeSelect) { typeSelect.addEventListener('change', () => { const isFolder = typeSelect.value === 'folder'; projectFormModalEl.querySelector('#files-container').classList.toggle('hidden', !isFolder); projectFormModalEl.querySelector('.url-container').classList.toggle('hidden', isFolder); });}
            projectFormModalEl.querySelector('#color-picker').addEventListener('click', (e) => { if(e.target.dataset.color) { projectFormModalEl.querySelector('[name="bgColor"]').value = e.target.dataset.color; projectFormModalEl.querySelectorAll('#color-picker button').forEach(b => b.classList.remove('ring-[var(--primary-start)]')); e.target.classList.add('ring-[var(--primary-start)]'); } });
            projectFormModalEl.querySelector('#icon-picker').addEventListener('click', (e) => { const button = e.target.closest('button'); if(button && button.dataset.icon) { projectFormModalEl.querySelector('[name="iconName"]').value = button.dataset.icon; projectFormModalEl.querySelectorAll('#icon-picker button').forEach(b => b.classList.remove('bg-[var(--secondary-bg)]', 'text-[var(--primary-start)]')); button.classList.add('bg-[var(--secondary-bg)]', 'text-[var(--primary-start)]'); } });
            lucide.createIcons();
        }
        
        async function showUserManagement() { /* ... content unchanged ... */ }
        function showConfirmation(message, onConfirm) { /* ... content unchanged ... */ }
        
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            return new Date(timestamp.toMillis()).toLocaleDateString('en-US', {
                year: 'numeric', month: 'long', day: 'numeric'
            });
        }
        
        function showProjectDetails(project) {
            const tagsHTML = project.tags && project.tags.length > 0 
                ? project.tags.map(tag => `<span class="tag-badge text-xs font-medium px-2.5 py-1 rounded-full">${tag}</span>`).join('')
                : '<span class="text-sm text-[var(--muted-foreground)]">No tags</span>';
            const actionButtonText = project.type === 'webapp' ? 'Open Web App' : 'View Files';

            projectDetailsModalEl.innerHTML = `
                <div class="modal-content glass-panel w-full max-w-lg rounded-2xl shadow-2xl">
                    <div class="p-6 flex items-start space-x-6">
                        <div class="flex-shrink-0 w-24 h-24 ${project.bgColor || 'bg-gray-500'} rounded-lg flex items-center justify-center shadow-inner-lg text-slate-800">${project.icon || ''}</div>
                        <div class="flex-1">
                            <h2 class="text-3xl font-bold">${project.title}</h2>
                            <p class="mt-1 text-sm text-[var(--muted-foreground)] uppercase font-semibold">${project.category}</p>
                        </div>
                         <button class="close-modal-btn text-[var(--muted-foreground)] hover:text-[var(--foreground)] transition-colors"><i data-lucide="x"></i></button>
                    </div>
                    <div class="px-6 pb-6 border-t border-[var(--card-border)]">
                        <p class="mt-4 text-base">${project.description || 'No description available.'}</p>
                        <div class="mt-6">
                            <h4 class="text-sm font-semibold mb-2 text-[var(--muted-foreground)]">Tags</h4>
                            <div class="flex flex-wrap gap-2">${tagsHTML}</div>
                        </div>
                        <div class="mt-6">
                             <h4 class="text-sm font-semibold mb-1 text-[var(--muted-foreground)]">Last Updated</h4>
                             <p>${formatTimestamp(project.lastUpdatedAt)}</p>
                        </div>
                    </div>
                    <div class="px-6 py-4 bg-[var(--secondary-bg)] rounded-b-2xl border-t border-[var(--card-border)]">
                        <button id="project-details-action-btn" data-id="${project.id}" class="btn-primary w-full font-semibold py-2.5 px-4 rounded-lg">${actionButtonText}</button>
                    </div>
                </div>`;
            projectDetailsModalEl.classList.remove('opacity-0', 'pointer-events-none');
            lucide.createIcons();
        }

        function showUserProfile() {
            userProfileModalEl.innerHTML = `
                 <div class="modal-content glass-panel w-full max-w-sm rounded-2xl shadow-2xl p-6 text-center">
                    <div class="flex justify-end"><button class="close-modal-btn text-[var(--muted-foreground)] hover:text-[var(--foreground)] transition-colors -mt-2 -mr-2"><i data-lucide="x"></i></button></div>
                    <i data-lucide="user-circle-2" class="w-20 h-20 mx-auto text-[var(--primary-start)]"></i>
                    <h2 class="text-2xl font-bold mt-4">${currentUser.email}</h2>
                    <p class="mt-1 text-sm uppercase font-semibold text-[var(--muted-foreground)]">${userRole}</p>
                    <div class="mt-6 text-left">
                        <button id="reset-password-btn" class="w-full btn-secondary font-semibold px-4 py-2 rounded-lg">Send Password Reset Email</button>
                         <p id="password-reset-status" class="text-sm text-center mt-3 h-4"></p>
                    </div>
                </div>
            `;
            userProfileModalEl.classList.remove('opacity-0', 'pointer-events-none');
            lucide.createIcons();
        }

        // --- Event Handlers & Logic ---
        async function handleFormSubmit(event, tags) {
            event.preventDefault();
            const form = event.target;
            const saveButton = form.querySelector('button[type="submit"]');
            const errorEl = form.querySelector('#form-error');
            saveButton.disabled = true; saveButton.textContent = 'Saving...'; errorEl.textContent = '';
            
            const id = form.elements.id.value; const title = form.title.value; const category = form.category.value;
            const iconName = form.iconName.value; const iconSVG = `<i data-lucide="${iconName}" class="w-8 h-8"></i>`;
            const files = [...form.querySelectorAll('[data-file-index]')].map(el => ({ title: el.querySelector('.file-title-input').value, url: el.querySelector('.file-url-input').value }));
            const projectData = { title, description: form.description.value, type: form.type.value, url: form.type.value === 'webapp' ? form.url.value : '', bgColor: form.bgColor.value, category, icon: iconSVG, iconName, tags: tags || [], files: form.type.value === 'folder' ? files : [], lastUpdatedAt: serverTimestamp() };

            try {
                if (id) {
                    await updateDoc(doc(db, "projects", id), projectData);
                    await createNotification("Updated", title);
                } else {
                    await addDoc(projectsCollection, projectData);
                    await createNotification("Added", title);
                }
                projectFormModalEl.classList.add('opacity-0', 'pointer-events-none');
            } catch (error) { console.error("Error saving project:", error); errorEl.textContent = `Error: ${error.message.replace('Firebase: ', '')}`;
            } finally { saveButton.disabled = false; saveButton.textContent = 'Save Project'; }
        }
        
        async function handleSignUpSubmit(e) { /* ... content unchanged ... */ }
        async function handleInviteSubmit(e) { /* ... content unchanged ... */ }

        function addParallaxEventListeners() {
            const cards = document.querySelectorAll('.project-card');
            cards.forEach(card => {
                card.addEventListener('mousemove', (e) => {
                    const rect = card.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    const { width, height } = rect;
                    const rotateX = (y - height / 2) / (height / 2) * -7; // Max 7deg rotation
                    const rotateY = (x - width / 2) / (width / 2) * 7;   // Max 7deg rotation
                    card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.02)`;
                });
                card.addEventListener('mouseleave', () => {
                    card.style.transform = 'perspective(1000px) rotateX(0) rotateY(0) scale(1)';
                });
            });
        }

        // --- Global Event Listeners ---
        document.addEventListener('click', async (e) => {
            if (e.target.closest('.close-modal-btn')) {
                e.target.closest('.modal').classList.add('opacity-0', 'pointer-events-none');
            }
            if (e.target.closest('#user-profile-btn')) {
                showUserProfile();
            }
            if (e.target.closest('#reset-password-btn')) {
                const statusEl = document.getElementById('password-reset-status');
                try {
                    await sendPasswordResetEmail(auth, currentUser.email);
                    statusEl.textContent = 'Password reset email sent!';
                    statusEl.className = 'text-green-500 text-center text-sm mt-3 h-4';
                } catch (error) {
                    console.error("Error sending password reset email:", error);
                    statusEl.textContent = error.message;
                    statusEl.className = 'text-[var(--destructive)] text-center text-sm mt-3 h-4';
                }
            }
            const projectDetailsActionBtn = e.target.closest('#project-details-action-btn');
            if (projectDetailsActionBtn) {
                const project = allProjects.find(p => p.id === projectDetailsActionBtn.dataset.id);
                projectDetailsModalEl.classList.add('opacity-0', 'pointer-events-none');
                if (project.type === 'webapp') {
                    window.open(project.url, '_blank', 'noopener noreferrer');
                } else if (project.type === 'folder') {
                    setTimeout(() => showFileList(project), 300); // Delay to allow details modal to close
                }
            }
            if (e.target.closest('.delete-invite-btn')) { const email = e.target.dataset.email; showConfirmation(`Revoke invite for "${email}"?`, async () => { try { await deleteDoc(doc(db, "invites", email)); showUserManagement(); } catch (error) { console.error("Error revoking invite:", error); } }); }
            if (e.target.closest('#add-file-btn')) { const list = document.getElementById('files-list'), fileEl = document.createElement('div'); fileEl.className = 'flex items-center space-x-2'; fileEl.dataset.fileIndex = list.children.length; fileEl.innerHTML = `<input type="text" placeholder="File Name" class="input-base file-title-input w-1/2 rounded-md px-3 py-2"><input type="url" placeholder="File URL" class="input-base file-url-input w-1/2 rounded-md px-3 py-2"><button type="button" class="remove-file-btn text-[var(--destructive)] hover:opacity-80 p-2">&times;</button>`; list.appendChild(fileEl); }
            if (e.target.closest('.remove-file-btn')) e.target.closest('[data-file-index]').remove();

            const card = e.target.closest('.project-card');
            // Handle tag clicks
            if(e.target.closest('.tag-badge')) {
                const tag = e.target.closest('.tag-badge').textContent;
                searchInput.value = `tag: ${tag}`;
                filterAndSearch();
                return; // Prevent card click logic from firing
            }

            if(!card || !currentUser) return;
            const projectId = card.dataset.id, project = allProjects.find(p => p.id === projectId); if(!project) return;
            
            // Card action buttons
            if (e.target.closest('.favorite-btn')) { favorites.includes(projectId) ? favorites = favorites.filter(id => id !== projectId) : favorites.push(projectId); saveToLocalStorage('favoriteProjects', favorites); renderAll(); return; }
            if (userRole === 'admin' && e.target.closest('.edit-btn')) { showProjectForm(project); return; }
            if (userRole === 'admin' && e.target.closest('.delete-btn')) { showConfirmation(`Delete "${project.title}" permanently?`, async () => { try { await deleteDoc(doc(db, "projects", projectId)); await createNotification("Deleted", project.title); } catch (error) { console.error("Error deleting document:", error); } }); return; }

            // If no action button was clicked, show details
            showProjectDetails(project);
        });

        userManagementModalEl.addEventListener('click', (e) => {
             if (e.target.closest('.tab-btn')) { const tab = e.target.dataset.tab; userManagementModalEl.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active')); e.target.classList.add('active'); if(tab === 'invites') { userManagementModalEl.querySelector('#invites-tab-content').classList.remove('hidden'); userManagementModalEl.querySelector('#users-tab-content').classList.add('hidden'); } else { userManagementModalEl.querySelector('#invites-tab-content').classList.add('hidden'); userManagementModalEl.querySelector('#users-tab-content').classList.remove('hidden'); } }
             if (e.target.closest('.delete-user-btn')) { const userId = e.target.closest('button').dataset.userid; const userEmail = e.target.closest('button').dataset.useremail; showConfirmation(`Delete user "${userEmail}" permanently? This cannot be undone.`, async () => { try { await deleteDoc(doc(db, "users", userId)); showUserManagement(); await createNotification("Deleted user", userEmail); } catch (error) { console.error("Error deleting user:", error); } }); }
        });
        
         userManagementModalEl.addEventListener('change', async (e) => {
            if (e.target.matches('.user-role-select')) { const userId = e.target.dataset.userid; const newRole = e.target.value; try { await updateDoc(doc(db, "users", userId), { role: newRole }); await createNotification("Updated role for", (await getDoc(doc(db, "users", userId))).data().email); } catch (error) { console.error("Error updating user role:", error); } }
        });

        authToggleLink.addEventListener('click', (e) => { e.preventDefault(); const isLoginVisible = !loginForm.classList.contains('hidden'); loginForm.classList.toggle('hidden', isLoginVisible); signupForm.classList.toggle('hidden', !isLoginVisible); e.target.textContent = isLoginVisible ? 'Already have an account? Sign In' : "Don't have an account? Sign Up"; authError.textContent = ''; signupError.textContent = ''; });
        loginForm.addEventListener('submit', (e) => { e.preventDefault(); authError.textContent = ''; signInWithEmailAndPassword(auth, loginForm.email.value, loginForm.password.value).catch(error => { console.error("Auth Error:", error); authError.textContent = 'Invalid email or password.'; });});
        signupForm.addEventListener('submit', handleSignUpSubmit);
        signOutBtn.addEventListener('click', () => signOut(auth));
        userManagementModalEl.addEventListener('submit', (e) => { if (e.target.id === 'invite-user-form') handleInviteSubmit(e); });
        
        filterNavigation.addEventListener('click', (e) => {
            const link = e.target.closest('.sidebar-filter-link');
            if (link) {
                e.preventDefault();
                activeFilter = link.dataset.category;
                renderFilterNavigation();
                filterAndSearch();
            }
        });

        searchInput.addEventListener('input', filterAndSearch);
        addProjectBtn.addEventListener('click', () => showProjectForm());
        manageUsersBtn.addEventListener('click', async () => {
             const usersSnapshot = await getDocs(usersCollection);
            const allUsers = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const invitesSnapshot = await getDocs(invitesCollection);
            const pendingInvites = invitesSnapshot.docs.map(doc => ({ email: doc.id, ...doc.data() }));
            const invitesHTML = pendingInvites.length > 0 ? pendingInvites.map(invite => `<li class="flex justify-between items-center p-2 bg-[var(--secondary-bg)] rounded-md"><div><span>${invite.email}</span><span class="text-xs uppercase font-semibold ml-2 px-2 py-1 rounded-full ${invite.role === 'admin' ? 'bg-red-500 text-white' : 'bg-gray-500 text-gray-200'}">${invite.role}</span></div><button data-email="${invite.email}" class="delete-invite-btn text-xl text-[var(--muted-foreground)] hover:text-[var(--destructive)] leading-none">&times;</button></li>`).join('') : `<li class="text-[var(--muted-foreground)] italic p-2">No pending invites.</li>`;
            const usersHTML = allUsers.length > 0 ? allUsers.map(user => `<li class="flex justify-between items-center p-2 bg-[var(--secondary-bg)] rounded-md"><span class="truncate pr-2" title="${user.email}">${user.email}</span><div class="flex items-center space-x-2"><select data-userid="${user.id}" class="user-role-select input-base rounded-md px-2 py-1 text-sm ${user.id === currentUser.uid ? 'opacity-50' : ''}" ${user.id === currentUser.uid ? 'disabled' : ''}><option value="viewer" ${user.role === 'viewer' ? 'selected' : ''}>Viewer</option><option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option></select><button data-userid="${user.id}" data-useremail="${user.email}" class="delete-user-btn text-[var(--muted-foreground)] hover:text-[var(--destructive)] p-1 ${user.id === currentUser.uid ? 'hidden' : ''}" ${user.id === currentUser.uid ? 'disabled' : ''}><i data-lucide="trash-2" class="h-4 w-4"></i></button></div></li>`).join('') : `<li class="text-[var(--muted-foreground)] italic p-2">No users found.</li>`;
            userManagementModalEl.innerHTML = `<div class="modal-content glass-panel w-full max-w-lg rounded-2xl shadow-2xl p-6"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">Manage Users</h2><button type="button" class="close-modal-btn text-[var(--muted-foreground)] hover:text-[var(--foreground)] transition-colors"><i data-lucide="x"></i></button></div><div class="border-b border-[var(--card-border)] mb-4"><nav class="-mb-px flex space-x-4" aria-label="Tabs"><button data-tab="invites" class="tab-btn active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Invites & Pending</button><button data-tab="users" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-[var(--muted-foreground)] hover:text-[var(--foreground)]">All Users</button></nav></div><div id="invites-tab-content"><form id="invite-user-form"><h4 class="text-lg font-semibold mb-2">Invite New User</h4><p class="text-[var(--muted-foreground)] mb-4 text-sm">The user can create an account using the invited email.</p><div class="flex space-x-2"><input type="email" name="inviteEmail" placeholder="New User's Email" required class="input-base flex-grow w-full rounded-md px-3 py-2"><select name="inviteRole" class="input-base rounded-md px-3 py-2"><option value="viewer" selected>Viewer</option><option value="admin">Admin</option></select></div><button type="submit" class="w-full mt-3 btn-primary font-semibold px-4 py-2 rounded-md hover:opacity-90">Send Invite</button><p id="invite-status" class="text-sm text-center mt-3 h-4"></p></form><div class="mt-6"><h4 class="text-lg font-semibold mb-2">Pending Invites</h4><ul id="pending-invites-list" class="space-y-2 max-h-48 overflow-y-auto mt-2">${invitesHTML}</ul></div></div><div id="users-tab-content" class="hidden"><h4 class="text-lg font-semibold mb-2">Manage Existing Users</h4><ul id="all-users-list" class="space-y-2 max-h-64 overflow-y-auto mt-2">${usersHTML}</ul></div></div>`;
            userManagementModalEl.classList.remove('opacity-0', 'pointer-events-none');
            lucide.createIcons();
        });

        // --- Theme & Notification Panel ---
        const initTheme = () => { if (localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark'); };
        themeSwitcher.addEventListener('click', () => { document.documentElement.classList.toggle('dark'); localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); });
        notificationBtn.addEventListener('click', (e) => { e.stopPropagation(); notificationPanel.classList.toggle('hidden'); });
        document.addEventListener('click', (e) => { if (!notificationPanel.contains(e.target) && !notificationBtn.contains(e.target)) notificationPanel.classList.add('hidden'); });
        document.addEventListener('mousemove', (e) => {
            document.documentElement.style.setProperty('--mouse-x', `${e.clientX}px`);
            document.documentElement.style.setProperty('--mouse-y', `${e.clientY}px`);
        });

        // --- Initial Load ---
        initTheme();
        lucide.createIcons();
    </script>
</body>
</html>

